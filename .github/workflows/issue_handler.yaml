name: Network Access Issue Handler

on:
  issues:
    types: 
      - opened
      - edited

jobs:
  process_access_request:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      issues: write

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'


      - name: Process Issue YAML
        id: issue_yaml
        if: "contains(github.event.issue.labels.*.name, 'skip-form-processing')"
        run: |
          # Ensure policies directory exists
          mkdir -p infrastructure/policies
          
          # Extract YAML from issue body
          jq -r '.issue.body' "$GITHUB_EVENT_PATH" \
            | sed -n '/```yaml/,/```/p' \
            | sed '/^```/d' \
            > /tmp/issue.yaml
          
          # Split YAML documents
          csplit -z /tmp/issue.yaml '/---/' '{*}'
          
          # Initialize tracking variables
          FILENAMES=()
          REGIONS=()
          
          # Process each document
          for file in xx*; do
            # Extract region
            REGION=$(grep -o 'region: [a-z0-9-]*' "$file" | head -1 | cut -d ' ' -f 2)
            THIRD_PARTY_NAME=$(grep 'thirdpartyName:' "$file" | awk '{print $2}' | tr '[:upper:]' '[:lower:]' | tr -d '\n')
            THIRD_PARTY_ID=$(grep 'thirdPartyID:' "$file" | awk '{print $2}' | tr -d '\n')
            
            # Fallback to safe naming if extraction fails
            if [ -z "$THIRD_PARTY_NAME" ] || [ -z "$THIRD_PARTY_ID" ]; then
              THIRD_PARTY_NAME="unknown"
              THIRD_PARTY_ID="policy"
            fi
            
            FILENAME="${THIRD_PARTY_NAME}-${THIRD_PARTY_ID}-${REGION}-policy.yaml"
            FILE="infrastructure/policies/${FILENAME}"
            
            # Copy the specific document to its file
            cp "$file" "$FILE"
            
            # Store filename and region
            FILENAMES+=("$FILENAME")
            REGIONS+=("$REGION")
          done
          
          # Clean up temporary files
          rm xx*
          
          # Output first filename and region for workflow compatibility
          echo "filename=${FILENAMES[0]}" >> "$GITHUB_OUTPUT"
          echo "region=${REGIONS[0]}" >> "$GITHUB_OUTPUT"
          
          # Save all filenames for later steps if needed
          printf '%s\n' "${FILENAMES[@]}" > /tmp/policy_filenames.txt
          printf '%s\n' "${REGIONS[@]}" > /tmp/policy_regions.txt

      # Set other outputs similar to form processing
      - name: Set Issue YAML Outputs
        id: yaml_outputs
        if: "contains(github.event.issue.labels.*.name, 'skip-form-processing')"
        run: |
          # Determine request type from labels
          if [ "$(grep -c 'privatelink-consumer' <<< "${{ join(github.event.issue.labels.*.name, '\n') }}")" -gt 0 ]; then
            echo "request_type=consumer" >> $GITHUB_OUTPUT
            echo "schema_file=privatelink-consumer-schema.json" >> $GITHUB_OUTPUT
          elif [ "$(grep -c 'privatelink-provider' <<< "${{ join(github.event.issue.labels.*.name, '\n') }}")" -gt 0 ]; then
            echo "request_type=provider" >> $GITHUB_OUTPUT
            echo "schema_file=privatelink-provider-schema.json" >> $GITHUB_OUTPUT
          fi
          
          # Set other issue details
          echo "issue_number=${{ github.event.issue.number }}" >> $GITHUB_OUTPUT
          echo "issue_author=${{ github.event.issue.user.login }}" >> $GITHUB_OUTPUT
          echo "issue_title=${{ github.event.issue.title }}" >> $GITHUB_OUTPUT
            
      - name: Process Issue Form
        id: issue_data
        if: "!contains(github.event.issue.labels.*.name, 'skip-form-processing')"
        run: |

          pip install --quiet yamllint PyYAML jsonschema

          # Make scripts executable
          chmod +x ./scripts/form_to_yaml.py ./scripts/validate_schema.py

          # Run the script to process the form data
          set -x  # Enable verbose output
          python3 ./scripts/form_to_yaml.py || {
            echo "Script failed. Checking debug log..."
            cat /tmp/form_to_yaml_debug.log
            exit 1
          }
          
          # Extract and set outputs
          REQUEST_TYPE=$(grep "request_type=" /tmp/form_to_yaml_debug.log | cut -d= -f2)
          echo "request_type=$REQUEST_TYPE" >> $GITHUB_OUTPUT
          
          # Extract region from the generated YAML
          REGION=$(grep -o 'region: [a-z0-9-]*' /tmp/issue.yaml | head -1 | cut -d ' ' -f 2)
          echo "region=$REGION" >> $GITHUB_OUTPUT
          
          # Set schema file
          if [ "$REQUEST_TYPE" = "consumer" ]; then
            echo "schema_file=privatelink-consumer-schema.json" >> $GITHUB_OUTPUT
          elif [ "$REQUEST_TYPE" = "provider" ]; then
            echo "schema_file=privatelink-provider-schema.json" >> $GITHUB_OUTPUT
          fi
          
          # Set other outputs
          ISSUE_NUMBER=$(jq -r '.issue.number' "$GITHUB_EVENT_PATH")
          ISSUE_AUTHOR=$(jq -r '.issue.user.login' "$GITHUB_EVENT_PATH")
          ISSUE_TITLE=$(jq -r '.issue.title' "$GITHUB_EVENT_PATH")
          
          echo "issue_number=$ISSUE_NUMBER" >> $GITHUB_OUTPUT
          echo "issue_author=$ISSUE_AUTHOR" >> $GITHUB_OUTPUT
          echo "issue_title=$ISSUE_TITLE" >> $GITHUB_OUTPUT
          
          # Display generated YAML for debugging
          echo "Generated YAML content:"
          cat /tmp/issue.yaml
          
          # Display debug log
          echo "Debug Log:"
          cat /tmp/form_to_yaml_debug.log

      - name: YAML Validation
        run: |
          pip install --quiet yamllint
          raw_output=$(yamllint --format standard -c .yamllint /tmp/issue.yaml 2>&1 || true)
          yamllint_output=$(echo "$raw_output" | sed 's|/tmp/issue.yaml:|line |')
          
          if [ -n "$yamllint_output" ]; then
            {
              echo "### ⚠️ yamllint found issues in your submitted YAML"
              echo '```yaml'
              echo "$yamllint_output"
              echo '```'
            } > /tmp/yamllint_output.txt
            
            echo "yamllint_error=true" >> $GITHUB_OUTPUT
            cat /tmp/yamllint_output.txt
          else
            echo "yamllint_error=false" >> $GITHUB_OUTPUT
          fi

      - name: Create validation comment
        if: steps.yaml_validation.outputs.yamllint_error == 'true' || steps.schema_validation.outputs.schema_error == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          {
            echo "### ⚠️ Validation Results"
            echo ""
            
            if [ "${{ steps.yaml_validation.outputs.yamllint_error }}" == "true" ]; then
              echo "#### YAML Formatting Issues:"
              echo '```yaml'
              cat /tmp/yamllint_output.txt
              echo '```'
              echo ""
            else
              echo "#### ✅ YAML Format Validation: Passed"
              echo ""
            fi
            
            if [ "${{ steps.schema_validation.outputs.schema_error }}" == "true" ]; then
              echo "#### Schema Validation Issues:"
              echo '```'
              cat /tmp/schema_output.txt
              echo '```'
            else
              echo "#### ✅ Schema Validation: Passed"
            fi
          } > /tmp/validation_comment.txt
          
          gh issue comment "${{ steps.issue_data.outputs.issue_number }}" --body-file /tmp/validation_comment.txt
          
          if [ "${{ steps.yaml_validation.outputs.yamllint_error }}" == "true" ] || [ "${{ steps.schema_validation.outputs.schema_error }}" == "true" ]; then
            echo "Validation errors found. Exiting workflow."
            exit 1
          fi

      - name: Prepare Policy File
        id: policy_file
        run: |
          # Ensure policies directory exists
          mkdir -p infrastructure/policies
          
          # Generate policy filename
          REGION="${{ steps.issue_data.outputs.region }}"
          THIRD_PARTY_NAME=$(grep 'thirdpartyName:' /tmp/issue.yaml | awk '{print $2}' | tr '[:upper:]' '[:lower:]' | tr -d '\n')
          THIRD_PARTY_ID=$(grep 'thirdPartyID:' /tmp/issue.yaml | awk '{print $2}' | tr -d '\n')
          
          # Fallback to safe naming if extraction fails
          if [ -z "$THIRD_PARTY_NAME" ] || [ -z "$THIRD_PARTY_ID" ]; then
            THIRD_PARTY_NAME="unknown"
            THIRD_PARTY_ID="policy"
          fi
          
          FILENAME="${THIRD_PARTY_NAME}-${THIRD_PARTY_ID}-${REGION}-policy.yaml"
          FILE="infrastructure/policies/${FILENAME}"
          
          # Copy YAML to policies directory
          cp /tmp/issue.yaml "$FILE"
          
          # Output the filename for subsequent steps
          echo "file=$FILE" >> "$GITHUB_OUTPUT"
          echo "filename=$FILENAME" >> "$GITHUB_OUTPUT"

      - name: Commit Changes and Create PR
        id: create_pr
        env:
          GH_TOKEN: ${{ secrets.PAT_GITHUB_ACTIONS }}
        run: |
          ISSUE_ID=${{ github.event.issue.number }}
          BRANCH="issue-${ISSUE_ID}"
          FILE="${{ steps.policy_file.outputs.file }}"
          FILENAME="${{ steps.policy_file.outputs.filename }}"
          LABEL=$(jq -r '.issue.labels[0].name' "$GITHUB_EVENT_PATH")
          AUTHOR=$(jq -r '.issue.user.login' "$GITHUB_EVENT_PATH")

          git config user.name "github-actions"
          git config user.email "github-actions@github.com"

          # Check if branch already exists
          if git ls-remote --heads origin | grep -q "refs/heads/$BRANCH"; then
            # Branch exists, create a unique branch name
            BRANCH="issue-${ISSUE_ID}-$(date +%s)"
          fi

          # Create and switch to the branch
          git checkout -b "$BRANCH"
          git add "$FILE"
          git commit -m "Append request from issue #${ISSUE_ID}"
          
          # Force push or push with lease to handle potential conflicts
          git push -f origin "$BRANCH"

          PR_URL=$(gh pr create \
            --title "[Auto] Add request from issue #${ISSUE_ID}" \
            --label "$LABEL" \
            --body "This PR adds a new request submitted in issue #${ISSUE_ID}." \
            --head "$BRANCH" \
            --base main)

          echo "🔍 PR created at $PR_URL"
          echo "author=$AUTHOR" >> "$GITHUB_OUTPUT"
          echo "🔎 Detected issue author: $AUTHOR"
          
          if [ "$AUTHOR" = "blahsadfawerwa3r23rwerwe" ]; then
            echo "✅ Auto-approving PR since author is $AUTHOR"
            gh pr merge "$PR_URL" --merge --delete-branch
            gh pr comment "$PR_URL" --body "✅ Auto-merged since this request was submitted by @$AUTHOR"
          else
            echo "ℹ️ PR created but not auto-approved. Submitted by @$AUTHOR"
          fi
